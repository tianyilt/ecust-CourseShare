$:
  vscode:
    - runner:
        cpus: 1
      docker:
        # æŒ‡å®šå¼€å‘ç¯å¢ƒé•œåƒï¼Œå¯ä»¥æ˜¯ä»»æ„å¯è®¿é—®çš„é•œåƒã€‚
        # å¦‚æœ image æŒ‡å®šçš„é•œåƒä¸­å·²å®‰è£… code-server ä»£ç æœåŠ¡ï¼Œå°†ä½¿ç”¨å•å®¹å™¨æ¨¡å¼å¯åŠ¨å¼€å‘ç¯å¢ƒ
        # å¦‚æœ image æŒ‡å®šçš„é•œåƒä¸­æœªå®‰è£… code-server ä»£ç æœåŠ¡ï¼Œå°†ä½¿ç”¨åŒå®¹å™¨æ¨¡å¼å¯åŠ¨å¼€å‘ç¯å¢ƒ
        # å¦‚ä¸‹é•œåƒä¸º CNB é»˜è®¤å¼€å‘ç¯å¢ƒé•œåƒï¼Œå·²å®‰è£…ä»£ç æœåŠ¡ï¼Œå°†ä½¿ç”¨å•å®¹å™¨æ¨¡å¼å¯åŠ¨å¼€å‘ç¯å¢ƒ
        # å¯æŒ‰éœ€æ›¿æ¢ä¸ºå…¶ä»–é•œåƒ
        image: cnbcool/default-dev-env:latest
      services:
        - vscode
        - docker

master:
  push:
    - name: sync to github
      runner:
        cpus: 1
      imports: https://cnb.cool/ecustcic/key/-/blob/main/env.yml
      stages:
        - name: Check Conflict & Push
          script: |
            git config --global user.name "$GITHUB_USERNAME"
            git config --global user.email "$MAIL"
            git remote add github https://$GITHUB_USERNAME:$GITHUB_ACCESS_TOKEN@github.com/tianyilt/ecust-CourseShare.git
            
            echo "ğŸ” 1. è·å– GitHub æœ€æ–°çŠ¶æ€..."
            git fetch github master
            
            if ! git pull --rebase github master; then
              echo "âŒ å†²çªæ£€æµ‹ï¼šGitHub ä¸Šæœ‰ä¸æœ¬åœ°å†²çªçš„ä¿®æ”¹ï¼"
              echo "âš ï¸ è¯·å…ˆæ‰‹åŠ¨åœ¨æœ¬åœ°è§£å†³å†²çªï¼Œæˆ–è€…åœ¨ GitHub ä¸Šè§£å†³åå†å°è¯•ã€‚"
              exit 1 # é€€å‡ºè„šæœ¬ï¼Œé˜²æ­¢é”™è¯¯æ¨é€
            fi
            
            echo "âœ… åˆå¹¶æˆåŠŸï¼ˆæˆ–è€…æ— å†²çªï¼‰ï¼Œå‡†å¤‡æ¨é€..."

            # --- æ¨é€ ---
            git push github master
            echo "ğŸš€ å·²æˆåŠŸåŒæ­¥åˆ° GitHub"
        
        - name: Check & Install Rclone
          script: |
            sed -i 's/deb.debian.org/mirrors.tencentyun.com/g' /etc/apt/sources.list.d/debian.sources
            apt update
            # ç¡®ä¿å®‰è£… curl
            apt install unzip dnsutils curl -y
            
            # DNS ä¿®æ­£é€»è¾‘ (ä¿ç•™åŸæ ·)
            nslookup $WEBDAV_CNAME | grep 'Address:' | tail -n1 | awk -v host="$WEBDAV_HOST" '{print $2 " " host}' >> /etc/hosts
            
            # -------------------------------------------------------
            # [æ–°å¢] çŠ¶æ€ç å‰ç½®æ£€æŸ¥
            # -------------------------------------------------------
            echo "ğŸ” æ­£åœ¨æ£€æŸ¥ WebDAV è¿é€šæ€§: $WEBDAV_URL"
            
            # è·å–çŠ¶æ€ç  (--max-time 3 é˜²æ­¢æœåŠ¡å™¨æ— å“åº”å¡ä½)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$WEBDAV_URL")
            
            if [ "$HTTP_CODE" != "401" ]; then
              echo "â›”ï¸ æ£€æµ‹åˆ° WebDAV çŠ¶æ€ç ä¸º: $HTTP_CODE"
              echo "âš ï¸ ç›®æ ‡é 401 çŠ¶æ€ï¼Œåœæ­¢åç»­ä»»åŠ¡ä»¥èŠ‚çœèµ„æºã€‚"
              exit 1  # é€€å‡ºç  1 ä¼šå¼ºåˆ¶ç»ˆæ­¢ Pipelineï¼Œåç»­çš„ Sync Stage ä¸ä¼šæ‰§è¡Œ
            fi
            
            echo "âœ… WebDAV çŠ¶æ€ç ä¸º 401ï¼ŒæœåŠ¡æ­£å¸¸ï¼Œç»§ç»­æ‰§è¡Œå®‰è£…..."
            # -------------------------------------------------------

            curl https://cnb.cool/bestzyq/rclone/-/git/raw/main/install.sh | bash

            echo "ğŸ§¹ æ¸…ç†ç©ºæ–‡ä»¶å’Œç©ºç›®å½•..."
            find . -type f -empty -not -path "./.git/*" -delete
            while [ -n "$(find . -type d -empty -not -path "./.git" -not -path "./.git/*" -print -quit)" ]; do
              find . -type d -empty -not -path "./.git" -not -path "./.git/*" -delete
            done

        - name: Rclone Sync to WebDAV
          timeout: 12h
          script: |
            # é…ç½® Rclone WebDAV
            rclone config create mycloud webdav url=$WEBDAV_URL vendor=other user=$WEBDAV_USER pass=$WEBDAV_PASSWORD
            
            # å¼€å§‹åŒæ­¥
            rclone sync . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --transfers 8 \
              --retries 3 \
              --retries-sleep 5s \
              --size-only \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
            echo "âœ… å·²åŒæ­¥åˆ°webdav"

            rclone check . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --size-only
            echo "âœ… å·²check"

  # å®šæ—¶ä»»åŠ¡é…ç½®
  "crontab: 0 2 */7 * *":  # æ¯7å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    - name: sync from github
      runner:
        cpus: 1
      imports:
        - https://cnb.cool/ecustcic/key/-/blob/main/webdav.yml
      stages:
        - name: setup-git
          script: |
            git remote add upstream https://github.com/tianyilt/ecust-CourseShare.git
            
            # 1. è®°å½•æ›´æ–°å‰çš„ Commit ID
            BEFORE_SHA=$(git rev-parse HEAD)
            
            git fetch upstream master
            if ! git pull --rebase upstream master; then
               echo "â›”ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çªï¼Œè·³è¿‡æœ¬æ¬¡æ›´æ–°ã€‚"
               exit 1
            fi

            # 2. è®°å½•æ›´æ–°åçš„ Commit ID
            AFTER_SHA=$(git rev-parse HEAD)

            # 3. æ ¸å¿ƒåˆ¤æ–­ï¼šå¦‚æœæ— å˜æ›´ï¼Œç›´æ¥é€€å‡º Pipeline
            if [ "$BEFORE_SHA" == "$AFTER_SHA" ]; then
                echo "ğŸ˜´ ä»£ç æ— å˜æ›´ï¼Œä»»åŠ¡æå‰ç»“æŸ (Exit 78)ã€‚"
                exit 78
            fi
            
            echo "âœ… æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå°†æ›´æ–°æ¨é€åˆ° CNB ä»“åº“å¹¶ç»§ç»­åç»­ WebDAV åŒæ­¥..."
            git push origin master
        
        - name: Check & Install Rclone
          script: |
            sed -i 's/deb.debian.org/mirrors.tencentyun.com/g' /etc/apt/sources.list.d/debian.sources
            apt update
            # ç¡®ä¿å®‰è£… curl
            apt install unzip dnsutils curl -y
            
            # DNS ä¿®æ­£é€»è¾‘ (ä¿ç•™åŸæ ·)
            nslookup $WEBDAV_CNAME | grep 'Address:' | tail -n1 | awk -v host="$WEBDAV_HOST" '{print $2 " " host}' >> /etc/hosts
            
            # -------------------------------------------------------
            # [æ–°å¢] çŠ¶æ€ç å‰ç½®æ£€æŸ¥
            # -------------------------------------------------------
            echo "ğŸ” æ­£åœ¨æ£€æŸ¥ WebDAV è¿é€šæ€§: $WEBDAV_URL"
            
            # è·å–çŠ¶æ€ç  (--max-time 3 é˜²æ­¢æœåŠ¡å™¨æ— å“åº”å¡ä½)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$WEBDAV_URL")
            
            if [ "$HTTP_CODE" != "401" ]; then
              echo "â›”ï¸ æ£€æµ‹åˆ° WebDAV çŠ¶æ€ç ä¸º: $HTTP_CODE"
              echo "âš ï¸ ç›®æ ‡é 401 çŠ¶æ€ï¼Œåœæ­¢åç»­ä»»åŠ¡ä»¥èŠ‚çœèµ„æºã€‚"
              exit 1  # é€€å‡ºç  1 ä¼šå¼ºåˆ¶ç»ˆæ­¢ Pipelineï¼Œåç»­çš„ Sync Stage ä¸ä¼šæ‰§è¡Œ
            fi
            
            echo "âœ… WebDAV çŠ¶æ€ç ä¸º 401ï¼ŒæœåŠ¡æ­£å¸¸ï¼Œç»§ç»­æ‰§è¡Œå®‰è£…..."
            # -------------------------------------------------------

            curl https://cnb.cool/bestzyq/rclone/-/git/raw/main/install.sh | bash

            echo "ğŸ§¹ æ¸…ç†ç©ºæ–‡ä»¶å’Œç©ºç›®å½•..."
            find . -type f -empty -not -path "./.git/*" -delete
            while [ -n "$(find . -type d -empty -not -path "./.git" -not -path "./.git/*" -print -quit)" ]; do
              find . -type d -empty -not -path "./.git" -not -path "./.git/*" -delete
            done

        - name: Rclone Sync to WebDAV
          timeout: 12h
          script: |
            # é…ç½® Rclone WebDAV
            rclone config create mycloud webdav url=$WEBDAV_URL vendor=other user=$WEBDAV_USER pass=$WEBDAV_PASSWORD
            
            # å¼€å§‹åŒæ­¥
            rclone sync . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --transfers 8 \
              --retries 3 \
              --retries-sleep 5s \
              --size-only \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
            echo "âœ… å·²åŒæ­¥åˆ°webdav"

            rclone check . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --size-only
            echo "âœ… å·²check"
  
  # Webè§¦å‘å™¨é…ç½® (åŒç†ä¿®æ”¹ manual-sync-webdav)
  web_trigger:
    - name: manual-sync-github
      runner:
        cpus: 1
      stages:
        - name: setup-git
          script: |
            git remote add upstream https://github.com/tianyilt/ecust-CourseShare.git
            git fetch upstream
            git checkout master
            git reset --hard upstream/master
            git push origin master --force
            echo "âœ… å·²åŒæ­¥ GitHub çš„ master åˆ†æ”¯åˆ° cnb.cool ä»“åº“"
            
  web_trigger_2:
    - name: manual-sync-cnb
      runner:
        cpus: 1
      imports: https://cnb.cool/ecustcic/key/-/blob/main/env.yml
      stages:
        - name: sync to github
          image: tencentcom/git-sync
          settings:
            target_url: https://github.com/tianyilt/ecust-CourseShare.git
            auth_type: https
            username: ${GITHUB_USERNAME}
            password: ${GITHUB_ACCESS_TOKEN}
            force: true

  web_trigger_1:
    - name: manual-sync-webdav
      runner:
        cpus: 1
      imports:
        - https://cnb.cool/ecustcic/key/-/blob/main/webdav.yml
      stages:
        - name: Check & Install Rclone
          script: |
            sed -i 's/deb.debian.org/mirrors.tencentyun.com/g' /etc/apt/sources.list.d/debian.sources
            apt update
            apt install unzip dnsutils curl -y
            nslookup $WEBDAV_CNAME | grep 'Address:' | tail -n1 | awk -v host="$WEBDAV_HOST" '{print $2 " " host}' >> /etc/hosts
            
            # --- æ£€æŸ¥é€»è¾‘ ---
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$WEBDAV_URL")
            if [ "$HTTP_CODE" != "401" ]; then
              echo "â›”ï¸ çŠ¶æ€ç  $HTTP_CODE (é401)ï¼Œåœæ­¢æ‰§è¡Œã€‚"
              exit 1
            fi
            # ---------------

            curl https://cnb.cool/bestzyq/rclone/-/git/raw/main/install.sh | bash

            echo "ğŸ§¹ æ¸…ç†ç©ºæ–‡ä»¶å’Œç©ºç›®å½•..."
            find . -type f -empty -not -path "./.git/*" -delete
            while [ -n "$(find . -type d -empty -not -path "./.git" -not -path "./.git/*" -print -quit)" ]; do
              find . -type d -empty -not -path "./.git" -not -path "./.git/*" -delete
            done
        - name: Rclone Sync to WebDAV
          timeout: 12h
          script: |
            # é…ç½® Rclone WebDAV
            rclone config create mycloud webdav url=$WEBDAV_URL vendor=other user=$WEBDAV_USER pass=$WEBDAV_PASSWORD
            # å¼€å§‹åŒæ­¥
            rclone sync . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --transfers 8 \
              --retries 3 \
              --retries-sleep 5s \
              --size-only \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
            echo "âœ… å·²åŒæ­¥åˆ°webdav"
            rclone check . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --size-only
            echo "âœ… å·²check"