name: Sync
master:
  # å®šæ—¶ä»»åŠ¡é…ç½®
  "crontab: 0 2 */7 * *":  # æ¯7å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    - name: sync
      runner:
        cpus: 1
      imports:
        - https://cnb.cool/ecustcic/key/-/blob/main/webdav.yml
      stages:
        - name: setup-git
          script: |
            git remote add upstream https://github.com/tianyilt/ecust-CourseShare.git
            git fetch upstream
            git checkout master
            git reset --hard upstream/master
            git push origin master --force
            echo "âœ… å·²åŒæ­¥ GitHub çš„ master åˆ†æ”¯åˆ° cnb.cool ä»“åº“"
        
        - name: Check & Install Rclone
          script: |
            sed -i 's/deb.debian.org/mirrors.tencentyun.com/g' /etc/apt/sources.list.d/debian.sources
            apt update
            # ç¡®ä¿å®‰è£… curl
            apt install unzip dnsutils curl -y
            
            # DNS ä¿®æ­£é€»è¾‘ (ä¿ç•™åŸæ ·)
            nslookup $WEBDAV_CNAME | grep 'Address:' | tail -n1 | awk -v host="$WEBDAV_HOST" '{print $2 " " host}' >> /etc/hosts
            
            # -------------------------------------------------------
            # [æ–°å¢] çŠ¶æ€ç å‰ç½®æ£€æŸ¥
            # -------------------------------------------------------
            echo "ğŸ” æ­£åœ¨æ£€æŸ¥ WebDAV è¿é€šæ€§: $WEBDAV_URL"
            
            # è·å–çŠ¶æ€ç  (--max-time 3 é˜²æ­¢æœåŠ¡å™¨æ— å“åº”å¡ä½)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$WEBDAV_URL")
            
            if [ "$HTTP_CODE" != "401" ]; then
              echo "â›”ï¸ æ£€æµ‹åˆ° WebDAV çŠ¶æ€ç ä¸º: $HTTP_CODE"
              echo "âš ï¸ ç›®æ ‡é 401 çŠ¶æ€ï¼Œåœæ­¢åç»­ä»»åŠ¡ä»¥èŠ‚çœèµ„æºã€‚"
              exit 1  # é€€å‡ºç  1 ä¼šå¼ºåˆ¶ç»ˆæ­¢ Pipelineï¼Œåç»­çš„ Sync Stage ä¸ä¼šæ‰§è¡Œ
            fi
            
            echo "âœ… WebDAV çŠ¶æ€ç ä¸º 401ï¼ŒæœåŠ¡æ­£å¸¸ï¼Œç»§ç»­æ‰§è¡Œå®‰è£…..."
            # -------------------------------------------------------

            curl https://cnb.cool/bestzyq/rclone/-/git/raw/main/install.sh | bash

        - name: Rclone Sync to WebDAV
          timeout: 12h
          script: |
            # é…ç½® Rclone WebDAV
            rclone config create mycloud webdav url=$WEBDAV_URL vendor=other user=$WEBDAV_USER pass=$WEBDAV_PASSWORD
            
            # å¼€å§‹åŒæ­¥
            rclone sync . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --transfers 8 \
              --retries 3 \
              --retries-sleep 5s \
              --size-only \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
            echo "âœ… å·²åŒæ­¥åˆ°webdav"

            rclone check . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --size-only
            echo "âœ… å·²check"
  
  # Webè§¦å‘å™¨é…ç½® (åŒç†ä¿®æ”¹ manual-sync-webdav)
  web_trigger:
    - name: manual-sync-github
      runner:
        cpus: 1
      stages:
        - name: setup-git
          script: |
            git remote add upstream https://github.com/tianyilt/ecust-CourseShare.git
            git fetch upstream
            git checkout master
            git reset --hard upstream/master
            git push origin master --force
            echo "âœ… å·²åŒæ­¥ GitHub çš„ master åˆ†æ”¯åˆ° cnb.cool ä»“åº“"

  web_trigger_1:
    - name: manual-sync-webdav
      runner:
        cpus: 1
      imports:
        - https://cnb.cool/ecustcic/key/-/blob/main/webdav.yml
      stages:
        - name: Check & Install Rclone
          script: |
            sed -i 's/deb.debian.org/mirrors.tencentyun.com/g' /etc/apt/sources.list.d/debian.sources
            apt update
            apt install unzip dnsutils curl -y
            nslookup $WEBDAV_CNAME | grep 'Address:' | tail -n1 | awk -v host="$WEBDAV_HOST" '{print $2 " " host}' >> /etc/hosts
            
            # --- æ£€æŸ¥é€»è¾‘ ---
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$WEBDAV_URL")
            if [ "$HTTP_CODE" != "401" ]; then
              echo "â›”ï¸ çŠ¶æ€ç  $HTTP_CODE (é401)ï¼Œåœæ­¢æ‰§è¡Œã€‚"
              exit 1
            fi
            # ---------------

            curl https://cnb.cool/bestzyq/rclone/-/git/raw/main/install.sh | bash
        - name: Rclone Sync to WebDAV
          timeout: 12h
          script: |
            # é…ç½® Rclone WebDAV
            rclone config create mycloud webdav url=$WEBDAV_URL vendor=other user=$WEBDAV_USER pass=$WEBDAV_PASSWORD
            # å¼€å§‹åŒæ­¥
            rclone sync . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --transfers 8 \
              --retries 3 \
              --retries-sleep 5s \
              --size-only \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
            echo "âœ… å·²åŒæ­¥åˆ°webdav"
            rclone check . mycloud:$WEBDAV_PATH \
              --exclude ".git/**" \
              --exclude ".github/**" \
              --size-only
            echo "âœ… å·²check"


